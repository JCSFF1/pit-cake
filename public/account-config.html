<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description"
            content="PitCake - receitas, cupcakes e muitas outras delicias." />
        <meta name="author" content="PitCake" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Alterar dados - Pit Cake</title>
        <link rel="stylesheet" href="../src/styles/accountConfig.css">
    </head>
    <body>

        <article id="update-verify-alert">
            <p>
                Verifique o seu email <br>antes de atualizá-lo.
                <ion-icon name="alert-circle-outline"></ion-icon>
            </p>
        </article>

        <article id="update-secess-alert">
            <p>
                Link enviado com sucesso!
                <ion-icon name="checkmark-done-circle-outline"></ion-icon>
            </p>
        </article>

        <header>
            <a href="appView.html" rel="noopener noreferrer"
                class="back-option">
                <ion-icon name="chevron-back-outline"></ion-icon>
            </a>

            <h2>Alterar dados</h2>
        </header>

        <main>
            <section class="main-content">

                <label for="verify" class="verify">
                    É necessário verificar o seu email atual antes de
                    atualizá-lo.
                    <button id="verify-email-button">Verificar</button>
                </label>

                <span class="line"></span>

                <article>
                    Novo Email:
                    <label for="newemail" class="newemail">
                        <input type="email"
                            id="emailUpdate"
                            autocomplete="off"
                            placeholder="novoemail@gmail.com"
                            required />
                        <button type="button" id="update-email-button">
                            <ion-icon name="send-outline"></ion-icon>
                        </button>
                    </label>
                </article>

                <span class="line"></span>

                <article>
                    Resetar senha:
                    <label for="resetPassword" class="resetPassword">
                        <input type="email"
                            id="passwordReset"
                            autocomplete="off"
                            placeholder="Digite seu email" />
                        <button type="button" id="update-password-button">
                            <ion-icon name="send-outline"></ion-icon>
                        </button>
                    </label>
                </article>
            </section>
        </main>

        <!-- import js -->
        <script src="scripts/Validations.js"></script>
        <!-- import icon -->
        <script type="module"
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule
            src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getAuth, updateEmail, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";

        // 1. Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2AHNt_PivaDLXIkNAcdp3VqTkyP3VLPM",
            authDomain: "pit-cake.firebaseapp.com",
            projectId: "pit-cake",
            storageBucket: "pit-cake.firebasestorage.app",
            messagingSenderId: "228216532358",
            appId: "1:228216532358:web:5488cd1695a894cbe7d007"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // 4. Evento de clique para atualizar o email
        document.getElementById("update-email-button").addEventListener("click", async () => {
            updateEmail(auth.currentUser, form.update().value)
            .then(() => {
                console.log("Email updated");
                cleanInputs();
            }).catch((error) => {
                // alert(getErrorMessage(error));
                const errorAlert = form.updateMessageError();
                errorAlert.style.display = "flex";

                setTimeout(() => {
                    errorAlert.style.display = "none";
                }, 3000);
                cleanInputs();
            });
        });

        document.getElementById("verify-email-button").addEventListener("click", async () => {
            sendEmailVerification(auth.currentUser)
            .then((response) => {
                window.location.href = "login.html";
            }).catch((error) => {
                alert(getErrorMessage(error));
            });
        });

        document.getElementById("update-password-button").addEventListener("click", () => {
            const email = form.reset().value;
            if (!email) {
                alert("Por favor, insira um email válido.");
                return;
            }
        
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert("Link de redefinição de senha enviado com sucesso!");
                    console.log("Email enviado");
                    cleanInputs();
                })
                .catch((error) => {
                    alert(getErrorMessage(error));
                    console.log("Erro ao enviar email:");
                    cleanInputs();
                });
        });

        function cleanInputs() {
            form.update().value = "";
            form.reset().value = "";
          }
          
          const form = {
            update: () => document.getElementById("emailUpdate"),
            reset: () => document.getElementById("passwordReset"),
            updateMessageError: () => document.getElementById("update-verify-alert")
          }

        function getErrorMessage(error) {
            switch (error.code) {
            case "auth/operation-not-allowed":
                return "Verifique o seu email antes de atualizá-lo.";
            case "auth/invalid-email":
                return "O email informado é inválido.";
            case "auth/email-already-in-use":
                return "O email informado já está em uso.";
            case "auth/requires-recent-login":
                return "É necessário fazer login novamente para atualizar o email.";
            case "auth/user-not-found":
                return "Usuário não encontrado.";
            case "auth/too-many-requests":
                return "Muitas tentativas. Tente novamente mais tarde.";
              default:
                return "Ocorreu um erro desconhecido. Por favor, tente novamente mais tarde.";
            }
        }
    </script>
    </body>
</html>